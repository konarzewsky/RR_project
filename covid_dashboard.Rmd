---
title: "Covid in the EU"
author: "Arkadiusz Koszyk, Wojciech Konarzewski"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document:
    code_folding: hide
params:
  country:
    label: "Country"
    value: Entire EU
    input: select
    choices: [Entire EU, Austria, Belgium, Bulgaria, Croatia, Cyprus, Czech Republic, Denmark, Estonia, Finland, France, Germany, Greece, Hungary, Ireland, Italy, Latvia, Lithuania, Luxembourg, Malta, Netherlands, Poland, Portugal, Romania, Slovakia, Slovenia, Spain, Sweden]
  date_from:
    label: "Date from"
    value: "2020-01-22"
    input: date
    min: "2020-01-22"
    max: !r format(Sys.time(), '%Y-%m-%d')
  date_to:
    label: "Date to"
    value: !r format(Sys.time(), '%Y-%m-%d')
    input: date
    min: "2020-01-22"
    max: !r format(Sys.time(), '%Y-%m-%d')
---

```{r, global_options, include=FALSE}
knitr::opts_chunk$set(
  results='hide', fig.keep='all', message=FALSE, warning=FALSE
)
```

```{r, libraries}
library(COVID19)
library(dplyr)
library(ggplot2)
library(sqldf)
library(tidyverse)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
```

```{r, eu_countries}
eu_countries <- c('Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden')
```

### Loading data for countries within the European Union
```{r, data_loading}
if (params$country == 'Entire EU') {
  country = eu_countries
} else {
  country = c(params$country)
}

data <- covid19(
  country = eu_countries,
  level = 1,
  start = params$date_from,
  end = params$date_to,
  verbose = FALSE
)
```

### Epidemiological variables
Definitions of variables are taken from the documentation of the [COVID-19 Data Hub](https://covid19datahub.io/index.html#covid-19-data-hub-)

| Variable    | Description |
| :---------- | :---------------- |
| `confirmed` | Cumulative number of confirmed cases. |
| `deaths`    | Cumulative number of deaths.        |
| `recovered` | Cumulative number of patients released from hospitals or reported recovered.        |
| `tests`    | Cumulative number of tests.       |
| `vaccines`    | Cumulative number of total doses administered.        |
| `people_vaccinated`    | Cumulative number of people who received at least one vaccine dose.        |
| `people_fully_vaccinated`    | Cumulative number of people who received all doses prescribed by the vaccination protocol.        |
| `hosp`    | Number of hospitalized patients on date.        |
| `icu`    | Number of hospitalized patients in intensive therapy on date.         |
| `vent`    | Number of patients requiring invasive ventilation on date.        |
| `population`    | Total population.        |
	
	

```{r, plots_tests_vaccines, fig.show="hold", out.width="50%"}
data$date_char = as.character(data$date)
data1 <- data[data$administrative_area_level_1 %in% country,]
data1$date_week <- cut(as.Date(data1$date_char), "week")
data1$date_week_char = as.character(data1$date_week)
data1 <- data1[order(data1$date),]

data_time_tests <- sqldf(
  "select
    date_week_char as date,
    sum(tests)/1000 as tests
  from data1
  group by 1
  order by 1 ASC",
  method = "raw"
)

data_time_tests <- data_time_tests %>%
  mutate_at(vars(tests), list(~ .x - lag(.x)))

ggplot(data = data_time_tests, aes(x = date, y = tests)) + 
  geom_bar(position="stack", stat="identity") +
  labs(
    x = "",
    y = "",
    title = "Weekly number of tests (thousands)",
    subtitle = paste(params$country,", ",params$date_from," - ", params$date_to, sep=""),
  ) + scale_y_continuous(labels = scales::comma) +
  scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +
  theme(legend.position = "none")

#############################################################

data_time_vaccines <- sqldf(
  "select
    date_week_char as date,
    sum(vaccines)/1000 as vaccines
  from data1
  group by 1
  order by 1 ASC",
  method = "raw"
)

data_time_vaccines <- data_time_vaccines %>%
  mutate_at(vars(vaccines), list(~ .x - lag(.x)))

ggplot(data = data_time_vaccines, aes(x = date, y = vaccines)) + 
  geom_bar(position="stack", stat="identity") +
  labs(
    x = "",
    y = "",
    title = "Vaccines - weekly number of total doses administered (thousands)",
    subtitle = paste(params$country,", ",params$date_from," - ", params$date_to, sep=""),
  ) + scale_y_continuous(labels = scales::comma) +
  scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +
  theme(legend.position = "none")
```

```{r, map_function}
plot_map <- function(data, fill, title, legend_position, high_color, limits, breaks, labels) {
  ggplot(data = data) +
  geom_sf(mapping = aes(fill = fill)) +
  scale_fill_gradient2(name = "", low = "white", high = high_color, na.value = "grey50", limits = limits, 
                        breaks = breaks,
                        labels = labels) +
  labs(title = title) +
  theme(plot.title.position = "plot", legend.position = legend_position, legend.key.width = unit(2.5, "cm"))
}
```

```{r, map_country, fig.align = 'center'}
world_map <- ne_countries(scale = 50, returnclass = 'sf')
data_countries <- data.frame(eu_countries)
data_countries$country_from_params <- ifelse(data_countries$eu_countries %in% country, 1, 0)
european_union_map <- 
  world_map %>% 
  filter(name_long %in% eu_countries)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries, by = c("name_long" = "eu_countries"))

plot_map(
  data = map,
  fill = map$country_from_params,
  title = params$country,
  legend_position = "none",
  high_color = "red",
  limits = NULL,
  breaks = NULL,
  labels = NULL
)
```

```{r, map_vaccinated, fig.show="hold", out.width="50%"}
data_countries_vaccines <- sqldf(
  "select
    administrative_area_level_1 as country,
    max(people_vaccinated)/1000000 as people_vaccinated
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union_map <- 
  world_map %>% 
  filter(name_long %in% eu_countries)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries_vaccines, by = c("name_long" = "country"))

plot_map(
  data = map,
  fill = map$people_vaccinated,
  title = "Number of vaccinated people (milions)",
  legend_position = "bottom",
  high_color = "blue",
  limits = c(0, 70),
  breaks = c(0, 10, 20, 30, 40, 50, 60, 70),
  labels = c('0', '10', '20', '30', '40', '50', '60', '70')
)

########################################################

data_countries_vaccines_full <- sqldf(
  "select
    administrative_area_level_1 as country,
    max(people_fully_vaccinated)/1000000 as people_fully_vaccinated
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union_map <- 
  world_map %>% 
  filter(name_long %in% eu_countries)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries_vaccines_full, by = c("name_long" = "country"))

plot_map(
  data = map,
  fill = map$people_fully_vaccinated,
  title = "Number of fully vaccinated people (milions)",
  legend_position = "bottom",
  high_color = "green",
  limits = c(0, 70),
  breaks = c(0, 10, 20, 30, 40, 50, 60, 70),
  labels = c('0', '10', '20', '30', '40', '50', '60', '70')
)
```

```{r, map_fully_vaccinated, fig.show="hold", out.width="50%"}
data_countries_vaccines_coeff <- sqldf(
  "select
    administrative_area_level_1 as country,
    1000000*max(people_vaccinated)/population as people_vaccinated
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union_map <- 
  world_map %>% 
  filter(name_long %in% eu_countries)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries_vaccines_coeff, by = c("name_long" = "country"))

plot_map(
  data = map,
  fill = map$people_vaccinated,
  title = "Number of vaccinated people (per million inhabitants)",
  legend_position = "bottom",
  high_color = "orange",
  limits = c(200000, 1000000),
  breaks = c(200000, 400000, 600000, 800000, 1000000),
  labels = c('200k', '400k', '600k', '800k', '1m')
)

########################################################

data_countries_vaccines_full_coeff <- sqldf(
  "select
    administrative_area_level_1 as country,
    1000000*max(people_fully_vaccinated)/population as people_fully_vaccinated
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union_map <- 
  world_map %>% 
  filter(name_long %in% eu_countries)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries_vaccines_full_coeff, by = c("name_long" = "country"))

plot_map(
  data = map,
  fill = map$people_fully_vaccinated,
  title = "Number of fully vaccinated people (per million inhabitants)",
  legend_position = "bottom",
  high_color = "purple",
  limits = c(200000, 1000000),
  breaks = c(200000, 400000, 600000, 800000, 1000000),
  labels = c('200k', '400k', '600k', '800k', '1m')
)
```

```{r}

```

