---
title: "Covid in the EU"
author: "Arkadiusz Koszyk, Wojciech Konarzewski"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
params:
  country:
    label: "Country"
    value: Entire EU
    input: select
    choices: [Entire EU, Austria, Belgium, Bulgaria, Croatia, Cyprus, Czech Republic, Denmark, Estonia, Finland, France, Germany, Greece, Hungary, Ireland, Italy, Latvia, Lithuania, Luxembourg, Malta, Netherlands, Poland, Portugal, Romania, Slovakia, Slovenia, Spain, Sweden]
  date_from:
    label: "Date from"
    value: "2020-01-22"
    input: date
    min: "2020-01-22"
    max: !r format(Sys.time(), '%Y-%m-%d')
  date_to:
    label: "Date to"
    value: !r format(Sys.time(), '%Y-%m-%d')
    input: date
    min: "2020-01-22"
    max: !r format(Sys.time(), '%Y-%m-%d')
---
### Libraries used
```{r message=FALSE, warning=FALSE}
library(COVID19)
library(dplyr)
library(ggplot2)
library(sqldf)
library(tidyverse)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
```

### Loading data for countries within the European Union
```{r }
if (params$country == 'Entire EU') {
  country = c('Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden')
} else {
  country = c(params$country)
}

data <- covid19(
  country = country,
  level = 1,
  start = params$date_from,
  end = params$date_to,
  verbose = FALSE
)
```

### Epidemiological variables
Definitions of variables are taken from the documentation of the [COVID-19 Data Hub](https://covid19datahub.io/index.html#covid-19-data-hub-)

| Variable    | Description |
| :---------- | :---------------- |
| `confirmed` | Cumulative number of confirmed cases. |
| `deaths`    | Cumulative number of deaths.        |
| `recovered` | Cumulative number of patients released from hospitals or reported recovered.        |
| `tests`    | Cumulative number of tests.       |
| `vaccines`    | Cumulative number of total doses administered.        |
| `people_vaccinated`    | Cumulative number of people who received at least one vaccine dose.        |
| `people_fully_vaccinated`    | Cumulative number of people who received all doses prescribed by the vaccination protocol.        |
| `hosp`    | Number of hospitalized patients on date.        |
| `icu`    | Number of hospitalized patients in intensive therapy on date.         |
| `vent`    | Number of patients requiring invasive ventilation on date.        |
| `population`    | Total population.        |
	
	

```{r }
data$date_char = as.character(data$date)
data_time_tests <- sqldf(
  "select
    date_char as date,
    sum(tests)/1000 as tests
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)

ggplot(data = data_time_tests, aes(x = date, y = tests)) + 
  geom_bar(position="stack", stat="identity") +
  labs(
    x = "",
    y = "",
    title = "Cumulative daily number of tests (thousands)",
    subtitle = paste(params$country,", ",params$date_from," - ", params$date_to, sep=""),
  ) + scale_y_continuous(labels = scales::comma) +
  scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +
  theme_classic()
```


```{r }
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union <- c('Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden')
data_countries <- data.frame(european_union)
data_countries$country_from_params <- ifelse(data_countries$european_union %in% country, 1, 0)
european_union_map <- 
  world_map %>% 
  filter(name_long %in% european_union)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries, by = c("name_long" = "european_union"))

ggplot(data = map) +
  geom_sf(mapping = aes(fill = country_from_params)) +
  scale_fill_gradient(name = "", low = "blue", high = "red", na.value = "grey50", labels = scales::comma) +
  labs(title = params$country) +
  theme(plot.title.position = "plot", legend.position="none")
```
```{r }
data_countries_vaccines <- sqldf(
  "select
    administrative_area_level_1 as country,
    max(people_vaccinated)/1000000 as people_vaccinated
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union <- c('Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden')
european_union_map <- 
  world_map %>% 
  filter(name_long %in% european_union)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries_vaccines, by = c("name_long" = "country"))

ggplot(data = map) +
  geom_sf(mapping = aes(fill = people_vaccinated)) +
  scale_fill_gradient(name = "", low = "blue", high = "red", na.value = "grey50", labels = scales::comma) +
  labs(title = "Number of vaccinated people (milions)") +
  theme(plot.title.position = "plot")
```

```{r }
data_countries_vaccines_full <- sqldf(
  "select
    administrative_area_level_1 as country,
    max(people_fully_vaccinated)/1000000 as people_fully_vaccinated
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union <- c('Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden')
european_union_map <- 
  world_map %>% 
  filter(name_long %in% european_union)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries_vaccines_full, by = c("name_long" = "country"))

ggplot(data = map) +
  geom_sf(mapping = aes(fill = people_fully_vaccinated)) +
  scale_fill_gradient(name = "", low = "blue", high = "red", na.value = "grey50", labels = scales::comma) +
  labs(title = "Number of fully vaccinated people (milions)") +
  theme(plot.title.position = "plot")
```
```{r }
data_countries_vaccines_coeff <- sqldf(
  "select
    administrative_area_level_1 as country,
    1000000*max(people_vaccinated)/population as people_vaccinated
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union <- c('Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden')
european_union_map <- 
  world_map %>% 
  filter(name_long %in% european_union)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries_vaccines_coeff, by = c("name_long" = "country"))

ggplot(data = map) +
  geom_sf(mapping = aes(fill = people_vaccinated)) +
  scale_fill_gradient(name = "", low = "blue", high = "red", na.value = "grey50", labels = scales::comma) +
  labs(title = "Number of vaccinated people (per million inhabitants)") +
  theme(plot.title.position = "plot")
```
```{r }
data_countries_vaccines_full_coeff <- sqldf(
  "select
    administrative_area_level_1 as country,
    1000000*max(people_fully_vaccinated)/population as people_fully_vaccinated
  from data
  group by 1
  order by 1 ASC",
  method = "raw"
)
world_map <- ne_countries(scale = 50, returnclass = 'sf')
european_union <- c('Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 'Slovenia', 'Spain', 'Sweden')
european_union_map <- 
  world_map %>% 
  filter(name_long %in% european_union)
bbox_europe <- st_bbox(c(xmin = -10, ymin = 20, xmax = 50, ymax = 80), crs = st_crs(european_union_map))
european_union_map_cropped <- st_crop(european_union_map, bbox_europe)
map <- 
  european_union_map_cropped %>% 
  left_join(data_countries_vaccines_full_coeff, by = c("name_long" = "country"))

ggplot(data = map) +
  geom_sf(mapping = aes(fill = people_fully_vaccinated)) +
  scale_fill_gradient(name = "", low = "blue", high = "red", na.value = "grey50", labels = scales::comma) +
  labs(title = "Number of fully vaccinated people (per million inhabitants)") +
  theme(plot.title.position = "plot")
```

```{r }

```
